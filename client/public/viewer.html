<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>PDF Viewer</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #525659;
      /* Dark background for the viewer area */
      display: flex;
      flex-direction: column;
      align-items: center;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      height: 100vh;
      overflow: hidden;
    }

    #controls {
      padding: 5px 10px;
      background: #f8f9fa;
      /* Light background for controls */
      border-bottom: 1px solid #dadce0;
      color: #3c4043;
      width: 100%;
      box-sizing: border-box;
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 5px;
      height: 40px;
    }

    .separator {
      width: 1px;
      height: 20px;
      background-color: #dadce0;
      margin: 0 5px;
    }

    button {
      cursor: pointer;
      padding: 4px;
      background: transparent;
      color: #5f6368;
      border: none;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 28px;
      min-height: 28px;
    }

    button:hover {
      background-color: #e8eaed;
      color: #202124;
    }

    button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    button svg {
      fill: currentColor;
      width: 20px;
      height: 20px;
    }

    #page_num_input {
      width: 40px;
      text-align: center;
      padding: 4px;
      border-radius: 4px;
      border: 1px solid #dadce0;
      color: #3c4043;
      font-size: 13px;
      margin: 0 5px;
    }

    #page_num_input:focus {
      outline: 2px solid #1a73e8;
      border-color: transparent;
    }

    .page-info {
      font-size: 13px;
      color: #5f6368;
      margin-right: 10px;
    }

    .zoom-info {
      font-size: 13px;
      color: #5f6368;
      min-width: 50px;
      text-align: center;
      background: #e8eaed;
      padding: 4px 8px;
      border-radius: 4px;
      margin-left: 5px;
    }

    #viewer-container {
      flex: 1;
      overflow: auto;
      width: 100%;
    }
  </style>
</head>

<body>
  <div id="controls">
    <!-- Pagination -->
    <button id="prev" title="Previous Page">
      <svg viewBox="0 0 24 24">
        <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
      </svg>
    </button>

    <div class="separator"></div>

    <button id="next" title="Next Page">
      <svg viewBox="0 0 24 24">
        <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z" />
      </svg>
    </button>

    <input type="number" id="page_num_input" value="1" min="1">
    <span class="page-info">of <span id="page_count">--</span></span>

    <div class="separator"></div>

    <!-- Zoom -->
    <button id="zoom_out" title="Zoom Out">
      <svg viewBox="0 0 24 24">
        <path d="M19 13H5v-2h14v2z" />
      </svg>
    </button>

    <div class="separator"></div>

    <button id="zoom_in" title="Zoom In">
      <svg viewBox="0 0 24 24">
        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
      </svg>
    </button>

    <span id="zoom_level" class="zoom-info">100%</span>

    <div style="flex: 1;"></div> <!-- Spacer -->

    <!-- Actions -->
    <button id="print" title="Print">
      <svg viewBox="0 0 24 24">
        <path
          d="M19 8h-1V3H6v5H5c-1.66 0-3 1.34-3 3v6h3v4h12v-4h3v-6c0-1.66-1.34-3-3-3zM8 5h8v3H8V5zm8 12v2H8v-2h8zm2-2v-2H6v2H4v-4c0-.55.45-1 1-1h14c.55 0 1 .45 1 1v4h-2z" />
        <circle cx="18" cy="11.5" r="1" />
      </svg>
    </button>

    <button id="download" title="Download">
      <svg viewBox="0 0 24 24">
        <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" />
      </svg>
    </button>
  </div>

  <div id="viewer-container">
    <canvas id="the-canvas"></canvas>
  </div>

  <div id="print-container"></div>

  <script type="module">
    import * as pdfjsLib from './pdf.min.mjs';

    // The workerSrc property shall be specified.
    pdfjsLib.GlobalWorkerOptions.workerSrc = './pdf.worker.min.mjs';

    const urlParams = new URLSearchParams(window.location.search);
    const url = urlParams.get('file');
    const fileName = urlParams.get('fileName') || 'document.pdf';

    // Set document title
    document.title = fileName;

    let pdfDoc = null,
      pageNum = 1,
      pageRendering = false,
      pageNumPending = null,
      scale = 1.0, // Start at 100%
      canvas = document.getElementById('the-canvas'),
      ctx = canvas.getContext('2d'),
      pageNumInput = document.getElementById('page_num_input'),
      zoomLevelDisplay = document.getElementById('zoom_level');

    function updateZoomDisplay() {
      zoomLevelDisplay.textContent = Math.round(scale * 100) + '%';
    }

    function renderPage(num) {
      pageRendering = true;
      // Fetch page
      pdfDoc.getPage(num).then(function (page) {
        var viewport = page.getViewport({
          scale: scale
        });
        canvas.height = viewport.height;
        canvas.width = viewport.width;

        // Render PDF page into canvas context
        var renderContext = {
          canvasContext: ctx,
          viewport: viewport
        };
        var renderTask = page.render(renderContext);

        // Wait for render to finish
        renderTask.promise.then(function () {
          pageRendering = false;
          if (pageNumPending !== null) {
            renderPage(pageNumPending);
            pageNumPending = null;
          }
        });
      });

      // Update page counters
      pageNumInput.value = num;
      updateZoomDisplay();
    }

    function queueRenderPage(num) {
      if (pageRendering) {
        pageNumPending = num;
      } else {
        renderPage(num);
      }
    }

    function onPrevPage() {
      if (pageNum <= 1) {
        return;
      }
      pageNum--;
      queueRenderPage(pageNum);
    }
    document.getElementById('prev').addEventListener('click', onPrevPage);

    function onNextPage() {
      if (pageNum >= pdfDoc.numPages) {
        return;
      }
      pageNum++;
      queueRenderPage(pageNum);
    }
    document.getElementById('next').addEventListener('click', onNextPage);

    // Pagination Input
    pageNumInput.addEventListener('change', function () {
      let num = parseInt(this.value);
      if (num >= 1 && num <= pdfDoc.numPages) {
        pageNum = num;
        queueRenderPage(pageNum);
      } else {
        this.value = pageNum; // Reset to current page if invalid
      }
    });

    // Zoom Logic
    document.getElementById('zoom_in').addEventListener('click', function () {
      scale += 0.25; // Larger increments
      queueRenderPage(pageNum);
    });

    document.getElementById('zoom_out').addEventListener('click', function () {
      if (scale > 0.25) {
        scale -= 0.25;
        queueRenderPage(pageNum);
      }
    });

    // Print Logic
    document.getElementById('print').addEventListener('click', async function () {
      const printContainer = document.getElementById('print-container');
      printContainer.innerHTML = ''; // Clear previous

      const printScale = 2.0; // Higher quality for print

      // Disable button to prevent multiple clicks
      const printBtn = document.getElementById('print');
      // Save original content (icon)
      const originalContent = printBtn.innerHTML;
      printBtn.innerHTML = '...';
      printBtn.disabled = true;

      try {
        for (let i = 1; i <= pdfDoc.numPages; i++) {
          const page = await pdfDoc.getPage(i);
          const viewport = page.getViewport({
            scale: printScale
          });

          const canvasWrapper = document.createElement('div');
          canvasWrapper.className = 'print-page';

          const printCanvas = document.createElement('canvas');
          printCanvas.height = viewport.height;
          printCanvas.width = viewport.width;

          const renderContext = {
            canvasContext: printCanvas.getContext('2d'),
            viewport: viewport
          };

          await page.render(renderContext).promise;

          canvasWrapper.appendChild(printCanvas);
          printContainer.appendChild(canvasWrapper);
        }

        window.print();

      } catch (error) {
        console.error('Print error:', error);
        alert('Error preparing print document.');
      } finally {
        printBtn.innerHTML = originalContent;
        printBtn.disabled = false;
      }
    });

    // Download Logic
    document.getElementById('download').addEventListener('click', function () {
      if (url) {
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }
    });

    if (url) {
      pdfjsLib.getDocument(url).promise.then(function (pdfDoc_) {
        pdfDoc = pdfDoc_;
        document.getElementById('page_count').textContent = pdfDoc.numPages;
        renderPage(pageNum);
      }, function (reason) {
        // PDF loading error
        console.error(reason);
        document.body.innerHTML = '<h2 style="color:red; padding: 20px;">Error loading PDF: ' + reason + '</h2>';
      });
    } else {
      document.body.innerHTML = '<h2>No PDF file specified</h2>';
    }
  </script>
</body>

</html>